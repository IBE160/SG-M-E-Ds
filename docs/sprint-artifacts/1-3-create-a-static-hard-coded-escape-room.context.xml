<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>3</storyId>
    <title>Create a Static, Hard-coded Escape Room</title>
    <status>drafted</status>
    <generatedAt>2025-12-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-3-create-a-static-hard-coded-escape-room.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>to create a single, hard-coded escape room with a few rooms and puzzles</iWant>
    <soThat>we have a complete, playable experience to test the core mechanics</soThat>
    <tasks>
- [x] AC 1: Design and define the 3-room sequence and puzzles.
  - [x] Subtask: Identify names and descriptions for Room 1, Room 2, Room 3.
  - [x] Subtask: Define at least two distinct puzzle types and their solutions for Room 1 and Room 2.
- [ ] AC 1: Implement the hard-coded room data.
  - [ ] Subtask: Create a data structure (e.g., Python dictionary in a new module like `data/rooms.py`) to hold room descriptions, connected rooms, and puzzle details.
- [ ] AC 1: Implement the hard-coded puzzle logic.
  - [ ] Subtask: Create functions in `services/game_logic.py` to evaluate puzzle solutions for the defined puzzles.
- [ ] AC 1: Integrate room navigation logic with Flask routes.
  - [ ] Subtask: Modify existing `move_player` route or create new routes to handle transitions between the 3 hard-coded rooms.
- [ ] AC 2: Implement "You escaped!" message display.
  - [ ] Subtask: Add logic to `routes.py` to detect completion of the final puzzle and render an escape message (e.g., via a new template or a message in the existing UI).
- [ ] AC 1, 2: Implement unit and integration tests.
  - [ ] Subtask: Write unit tests for the hard-coded room data structure.
  - [ ] Subtask: Write unit tests for puzzle logic functions.
  - [ ] Subtask: Write integration tests for Flask routes handling room navigation and puzzle interaction, verifying correct state changes and "You escaped!" trigger.
</tasks>
  </story>

  <acceptanceCriteria>
    <criterion>Given the game has started, when the player navigates through the rooms, then they encounter a 3-room sequence with at least two distinct puzzles (e.g., an observation puzzle in Room 1, a riddle in Room 2).</criterion>
    <criterion>And solving the final puzzle in Room 3 triggers a "You escaped!" message.</criterion>
</acceptanceCriteria>

  <artifacts>
<docs>
    <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document: AI Escape</title>
        <section>FR-004: Core Interaction Loop</section>
        <snippet>Players interact with rooms and objects through a system of contextual options and a "go back" function to navigate.</snippet>
    </doc>
    <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document: AI Escape</title>
        <section>FR-009: Small Puzzle Set</section>
        <snippet>2-3 distinct puzzle types (e.g., Observation, Riddle) that the AI can adapt.</snippet>
    </doc>
    <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Project Structure</section>
        <snippet>The project will follow a structured Flask application layout including `app.py`, `static/`, `templates/`, `models.py`, `routes.py`, and `services/` directories. This includes `static/images/` for assets.</snippet>
    </doc>
    <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Comprehensive Testing Strategy</section>
        <snippet>A multi-layered testing strategy will be employed: Pytest for unit and integration tests, and Playwright for E2E tests.</snippet>
    </doc>
    <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>API Pattern for AI interactions</section>
        <snippet>Flask API routes will handle communication between the frontend and backend game logic.</snippet>
    </doc>
    <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Game State Transition Flow</section>
        <snippet>The core game loop follows a well-defined state transition flow, managed by the backend: `GameSession` is created at "Start Game", and updated on "Player Action" and "AI Response & State Change" cycles.</snippet>
    </doc>
    <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Epic 1: Foundational Framework & A Single, Static Escape Room</section>
        <snippet>Epic 1 aims to build a robust technical foundation and a complete, testable, end-to-end user experience with a single, hard-coded story and puzzle chain.</snippet>
    </doc>
    <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Story 1.3: Create a Static, Hard-coded Escape Room</section>
        <snippet>Story 1.3 focuses on creating a playable sequence of 3 rooms with 2-3 distinct, hard-coded puzzles to validate core mechanics and user flow.</snippet>
    </doc>
    <doc>
        <path>docs/ux-design-specification.md</path>
        <title>AI Escape - UX Design Specification</title>
        <section>2. Visual Foundation</section>
        <snippet>The UX Design Specification outlines visual foundations (retro-futuristic colors, `Press Start 2P`, `Roboto Mono` fonts), responsive design strategy for mobile/tablet/desktop, and an accessibility strategy targeting WCAG 2.1 Level AA compliance.</snippet>
    </doc>
</docs>
    <code>
        <code-ref>
            <path>ai-escape-app/app.py</path>
            <kind>file</kind>
            <reason>Main Flask application entry point</reason>
        </code-ref>
        <code-ref>
            <path>ai-escape-app/requirements.txt</path>
            <kind>file</kind>
            <reason>Project dependencies</reason>
        </code-ref>
        <code-ref>
            <path>ai-escape-app/.env</path>
            <kind>file</kind>
            <reason>Environment variables for local development</reason>
        </code-ref>
        <code-ref>
            <path>ai-escape-app/.flaskenv</path>
            <kind>file</kind>
            <reason>Flask environment variables</reason>
        </code-ref>
        <code-ref>
            <path>ai-escape-app/static/</path>
            <kind>directory</kind>
            <reason>For basic static assets like images</reason>
        </code-ref>
        <code-ref>
            <path>ai-escape-app/templates/</path>
            <kind>directory</kind>
            <reason>For Jinja2 HTML templates</reason>
        </code-ref>
        <code-ref>
            <path>.github/workflows/</path>
            <kind>directory</kind>
            <reason>For CI/CD workflow definitions</reason>
        </code-ref>
        <code-ref>
            <path>ai-escape-app/tests/</path>
            <kind>directory</kind>
            <reason>For unit and integration tests</reason>
        </code-ref>
    </code>
    <dependencies>
      <python>
        <package name="Flask" version="3.1.2" />
        <package name="python-dotenv" version="?" />
        <package name="gunicorn" version="?" />
        <package name="pytest" version="?" />
        <note>Versions from docs/architecture.md and 1-1-project-initialization-and-deployment-setup.md</note>
      </python>
      <node>
        <package name="playwright" version="?" />
        <note>Existing Node.js project dependencies for E2E testing</note>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>
        <type>Required Pattern</type>
        <description>Python Flask application structure (modular, with `app.py`, `static/`, `templates/`, `models.py`, `routes.py`, `services/`, `tests/`).</description>
        <source>docs/architecture.md#Project-Structure</source>
    </constraint>
    <constraint>
        <type>Required Pattern</type>
        <description>WCAG 2.1 Level AA accessibility compliance.</description>
        <source>docs/architecture.md#Accessibility-Implementation</source>
    </constraint>
    <constraint>
        <type>Required Pattern</type>
        <description>Stateless JWT Authentication.</description>
        <source>docs/architecture.md#Security-Architecture</source>
    </constraint>
    <constraint>
        <type>Layer Restriction</type>
        <description>Frontend (Jinja2 templates/Static assets) &lt;-> Backend (Flask Routes/API Endpoints).</description>
        <source>docs/architecture.md#Integration-Points</source>
    </constraint>
    <constraint>
        <type>Layer Restriction</type>
        <description>Flask Routes/API Endpoints &lt;-> AI Service (Gemini API).</description>
        <source>docs/architecture.md#Integration-Points</source>
    </constraint>
    <constraint>
        <type>Layer Restriction</type>
        <description>Flask Routes/API Endpoints &lt;-> Database (Supabase PostgreSQL via SQLAlchemy).</description>
        <source>docs/architecture.md#Integration-Points</source>
    </constraint>
    <constraint>
        <type>Testing Requirement</type>
        <description>Unit Tests (Pytest with `pytest-mock`).</description>
        <source>docs/architecture.md#Comprehensive-Testing-Strategy</source>
    </constraint>
    <constraint>
        <type>Testing Requirement</type>
        <description>Integration Tests (Pytest).</description>
        <source>docs/architecture.md#Comprehensive-Testing-Strategy</source>
    </constraint>
    <constraint>
        <type>Testing Requirement</type>
        <description>E2E Tests (Playwright).</description>
        <source>docs/architecture.md#Comprehensive-Testing-Strategy</source>
    </constraint>
    <constraint>
        <type>Coding Standard</type>
        <description>Python Classes: `PascalCase`, Python Functions/Variables: `snake_case`, Python Modules/Files: `snake_case`, Database Tables: `snake_case` (plural), Database Columns: `snake_case`, API Endpoints: `kebab-case` for URL paths, `snake_case` for query parameters, Constants: `SCREAMING_SNAKE_CASE`.</description>
        <source>docs/architecture.md#Consistency-Rules</source>
    </constraint>
    <constraint>
        <type>Coding Standard</type>
        <description>Code Organization: Modular Flask application layout.</description>
        <source>docs/architecture.md#Code-Organization</source>
    </constraint>
</constraints>

<interfaces></interfaces>
  <tests>
    <standards>
      <standard>
        <framework>Pytest</framework>
        <type>Unit, Integration</type>
        <note>Use `pytest-mock` for unit testing isolation if needed.</note>
        <source>docs/architecture.md#Comprehensive-Testing-Strategy</source>
      </standard>
      <standard>
        <framework>Playwright</framework>
        <type>E2E</type>
        <source>docs/architecture.md#Comprehensive-Testing-Strategy</source>
      </standard>
    </standards>
    <locations>
      <location>tests/</location>
      <note>Mirroring the application's module structure (e.g., `tests/unit/`, `tests/integration/`).</note>
    </locations>
    <ideas>
      <idea ac="1">
        <description>Write unit tests for the hard-coded room data structure.</description>
      </idea>
      <idea ac="1">
        <description>Write unit tests for puzzle logic functions.</description>
      </idea>
      <idea ac="1">
        <description>Write integration tests for Flask routes handling room navigation and puzzle interaction, verifying correct state changes and "You escaped!" trigger.</description>
      </idea>
    </ideas>
  </tests>
</story-context>