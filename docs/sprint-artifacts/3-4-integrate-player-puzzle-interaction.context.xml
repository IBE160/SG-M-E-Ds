<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>4</storyId>
    <title>Integrate Player Puzzle Interaction</title>
    <status>drafted</status>
    <generatedAt>2025-12-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-4-integrate-player-puzzle-interaction.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>player</asA>
    <iWant>to interact with puzzles using contextual options and input mechanisms</iWant>
    <soThat>I can attempt solutions and progress through the game</soThat>
    <tasks>
- [ ] AC 1: Extend Flask routes for puzzle interaction.
  - [ ] Subtask: Modify or create new Flask routes (e.g., `POST /puzzle_interaction`) to receive player input for puzzle attempts.
  - [ ] Subtask: This route will communicate with `services/ai_service.py` to get AI feedback on the input.
- [ ] AC 1: Implement UI for puzzle interaction.
  - [ ] Subtask: Modify Jinja2 templates to display contextual interaction options for puzzles.
  - [ ] Subtask: Integrate text input mechanisms for more complex puzzle answers if required.
  - [ ] Subtask: Utilize existing `.option-btn` components where appropriate.
- [ ] AC 1: Integrate AI puzzle logic feedback.
  - [ ] Subtask: Parse feedback from `services/ai_service.py` (e.g., correct, incorrect, hint) and display it to the player in the UI.
  - [ ] Subtask: Ensure a consistent user experience with defined "Feedback Patterns".
- [ ] AC 1: Implement unit and integration tests.
  - [ ] Subtask: Write unit tests for `services/ai_service.py` functions related to evaluating player input for puzzles.
  - [ ] Subtask: Write integration tests for the Flask routes handling player puzzle interaction, verifying input processing and feedback generation.
  - [ ] Subtask: Write E2E tests to simulate player interaction with puzzles and verify correct feedback and game progression.
</tasks>
  </story>

  <acceptanceCriteria>
    <criterion>Given a puzzle is presented, when the player selects an interaction option (e.g., "Examine the inscription", "Try combination 123"), then the game processes the input and provides feedback based on the AI's puzzle logic.</criterion>
</acceptanceCriteria>

  <artifacts>
<docs>
    <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document: AI Escape</title>
        <section>FR-004: Core Interaction Loop</section>
        <snippet>Players interact with rooms and objects through a system of contextual options and a "go back" function.</snippet>
    </doc>
    <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>API Pattern for AI interactions</section>
        <snippet>Flask API Routes will handle communication between the frontend and AI generation logic.</snippet>
    </doc>
    <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>UX</section>
        <snippet>Core Interaction Model (contextual options, go back function).</snippet>
    </doc>
    <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Error Handling Strategy</section>
        <snippet>Centralized error handling within Flask with user-friendly feedback.</snippet>
    </doc>
    <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Testing Strategy</section>
        <snippet>Unit, Integration Tests using Pytest.</snippet>
    </doc>
    <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Epic 3: The AI Puzzle Master</section>
        <snippet>This Epic focuses on empowering the AI to dynamically generate and adapt puzzles within the "AI Escape" game, building upon the coherent narrative framework established in Epic 2.</snippet>
    </doc>
    <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Story 3.4: Integrate Player Puzzle Interaction</section>
        <snippet>Story 3.4 focuses on allowing players to interact with puzzles using contextual options and input mechanisms, and to provide feedback based on AI puzzle logic.</snippet>
    </doc>
    <doc>
        <path>docs/ux-design-specification.md</path>
        <title>AI Escape - UX Design Specification</title>
        <section>5. User Journey Flows</section>
        <snippet>UX Design outlines user journey flows for New Game Creation and Load Game, which will rely on the backend's game state management to function correctly. This implies the need for dynamic content in the UI.</snippet>
    </doc>
</docs>
    <code>
        <code-ref>
            <path>routes.py</path>
            <kind>file</kind>
            <reason>Modify or create new Flask routes (`POST /puzzle_interaction`)</reason>
        </code-ref>
        <code-ref>
            <path>services/ai_service.py</path>
            <kind>file</kind>
            <reason>Communicate with to get AI feedback on player input</reason>
        </code-ref>
        <code-ref>
            <path>templates/</path>
            <kind>directory</kind>
            <reason>Modify Jinja2 templates to display contextual interaction options</reason>
        </code-ref>
        <code-ref>
            <path>tests/</path>
            <kind>directory</kind>
            <reason>For new unit, integration, and E2E tests</reason>
        </code-ref>
    </code>
    <dependencies>
      <python>
        <package name="Flask" version="3.1.2" />
        <package name="python-dotenv" version="?" />
        <package name="gunicorn" version="?" />
        <package name="pytest" version="?" />
        <package name="google-generativeai" version="0.8.5" />
        <note>Core Python dependencies for the Flask application and Google Gemini API client.</note>
      </python>
      <node>
        <package name="playwright" version="?" />
        <note>Existing Node.js project dependencies for E2E testing.</note>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>
        <type>Required Pattern</type>
        <description>Python Flask application structure (modular, with `app.py`, `static/`, `templates/`, `models.py`, `routes.py`, `services/`, `tests/`).</description>
        <source>docs/architecture.md#Project-Structure</source>
    </constraint>
    <constraint>
        <type>Required Pattern</type>
        <description>WCAG 2.1 Level AA accessibility compliance.</description>
        <source>docs/architecture.md#Accessibility-Implementation</source>
    </constraint>
    <constraint>
        <type>Required Pattern</type>
        <description>Stateless JWT Authentication.</description>
        <source>docs/architecture.md#Security-Architecture</source>
    </constraint>
    <constraint>
        <type>Layer Restriction</type>
        <description>Frontend (Jinja2 templates/Static assets) &lt;-> Backend (Flask Routes/API Endpoints).</description>
        <source>docs/architecture.md#Integration-Points</source>
    </constraint>
    <constraint>
        <type>Layer Restriction</type>
        <description>Flask Routes/API Endpoints &lt;-> AI Service (Gemini API).</description>
        <source>docs/architecture.md#Integration-Points</source>
    </constraint>
    <constraint>
        <type>Layer Restriction</type>
        <description>Flask Routes/API Endpoints &lt;-> Database (Supabase PostgreSQL via SQLAlchemy).</description>
        <source>docs/architecture.md#Integration-Points</source>
    </constraint>
    <constraint>
        <type>Testing Requirement</type>
        <description>Unit Tests (Pytest with `pytest-mock`).</description>
        <source>docs/architecture.md#Comprehensive-Testing-Strategy</source>
    </constraint>
    <constraint>
        <type>Testing Requirement</type>
        <description>Integration Tests (Pytest).</description>
        <source>docs/architecture.md#Comprehensive-Testing-Strategy</source>
    </constraint>
    <constraint>
        <type>Testing Requirement</type>
        <description>E2E Tests (Playwright).</description>
        <source>docs/architecture.md#Comprehensive-Testing-Strategy</source>
    </constraint>
    <constraint>
        <type>Coding Standard</type>
        <description>Python Classes: `PascalCase`, Python Functions/Variables: `snake_case`, Python Modules/Files: `snake_case`, Database Tables: `snake_case` (plural), Database Columns: `snake_case`, API Endpoints: `kebab-case` for URL paths, `snake_case` for query parameters, Constants: `SCREAMING_SNAKE_CASE`.</description>
        <source>docs/architecture.md#Consistency-Rules</source>
    </constraint>
    <constraint>
        <type>Coding Standard</type>
        <description>Code Organization: Modular Flask application layout.</description>
        <source>docs/architecture.md#Code-Organization</source>
    </constraint>
</constraints>

<interfaces>
    <interface>
        <name>/puzzle_interaction</name>
        <kind>REST endpoint</kind>
        <signature>POST /puzzle_interaction</signature>
        <path>routes.py</path>
    </interface>
    <interface>
        <name>/evaluate_puzzle_solution</name>
        <kind>REST endpoint</kind>
        <signature>POST /evaluate_puzzle_solution</signature>
        <path>routes.py</path>
    </interface>
    <interface>
        <name>/adapt_puzzle</name>
        <kind>REST endpoint</kind>
        <signature>POST /adapt_puzzle</signature>
        <path>routes.py</path>
    </interface>
</interfaces>
  <tests>
    <standards>
      <standard>
        <framework>Pytest</framework>
        <type>Unit, Integration</type>
        <note>Unit tests should mock the Gemini API.</note>
        <source>docs/architecture.md#Testing-Strategy</source>
      </standard>
      <standard>
        <framework>Playwright</framework>
        <type>E2E</type>
        <source>docs/architecture.md#Comprehensive-Testing-Strategy</source>
      </standard>
    </standards>
    <locations>
      <location>tests/</location>
      <note>Mirroring the application's module structure (e.g., `tests/unit/`, `tests/integration/`).</note>
    </locations>
    <ideas>
      <idea ac="1">
        <description>Write unit tests for `services/ai_service.py` functions related to evaluating player input for puzzles.</description>
      </idea>
      <idea ac="1">
        <description>Write integration tests for the Flask routes handling player puzzle interaction, verifying input processing and feedback generation.</description>
      </idea>
      <idea ac="1">
        <description>Write E2E tests to simulate player interaction with puzzles and verify correct feedback and game progression.</description>
      </idea>
    </ideas>
  </tests>
</story-context>