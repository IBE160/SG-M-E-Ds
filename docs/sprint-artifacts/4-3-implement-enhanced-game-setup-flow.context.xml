<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>3</storyId>
    <title>Implement Enhanced Game Setup Flow</title>
    <status>done</status>
    <generatedAt>2025-12-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/4-3-implement-enhanced-game-setup-flow.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>player</asA>
    <iWant>an enhanced game setup flow with more options and clearer guidance</iWant>
    <soThat>I can customize my experience more effectively</soThat>
    <tasks>
- [ ] AC 1: Define expanded lists of themes, locations, puzzle types, and difficulty levels.
  - [ ] Subtask: Document the new options and their descriptions.
  - [ ] Subtask: Store these options in a structured format accessible by the backend (e.g., configuration file, database).
- [ ] AC 1: Create or update Flask API routes to expose game setup options.
  - [ ] Subtask: Define a `GET /game_setup_options` endpoint in `routes.py` to retrieve the expanded list of choices.
- [ ] AC 1: Implement enhanced UI for game setup.
  - [ ] Subtask: Modify Jinja2 templates (e.g., `templates/game_setup.html`) to present the expanded options clearly.
  - [ ] Subtask: Utilize `.option-btn` components and incorporate improved instructional text from UX design specifications.
- [ ] AC 1: Integrate player choices with `GameSession` initialization.
  - [ ] Subtask: Ensure selected themes, locations, puzzle types, and difficulty levels are passed to `create_game_session` (Story 1.2) and stored in `GameSession`.
- [ ] AC 1: Implement unit and integration tests.
  - [ ] Subtask: Write unit tests for the data structure holding game setup options.
  - [ ] Subtask: Write integration tests for the `GET /game_setup_options` Flask route, verifying correct option retrieval.
  - [ ] Subtask: Write E2E tests to simulate player interaction with the enhanced game setup flow and verify correct option display and selection.
</tasks>
  </story>

  <acceptanceCriteria>
    <criterion>Given the game setup menu, when I navigate through the options, then I can choose from an expanded list of themes, locations, puzzle types, and difficulty levels, with clear descriptions for each.</criterion>
</acceptanceCriteria>

  <artifacts>
<docs>
    <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document: AI Escape</title>
        <section>FR-002: Player-Driven Customization</section>
        <snippet>Players tailor their adventure by choosing a theme, location, difficulty level.</snippet>
    </doc>
    <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document: AI Escape</title>
        <section>FR-006: User flow for Game Setup</section>
        <snippet>The user flow for the Game Setup will guide the player through choices (Theme -> Location -> Room Count -> Difficulty) before starting.</snippet>
    </doc>
    <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>UX</section>
        <snippet>Enhanced Game Setup Flow will leverage existing `.option-btn` components and improved instructional text, consistent with the UX design.</snippet>
    </doc>
    <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</path>
        <section>API Pattern for AI interactions</section>
        <snippet>Flask API Routes will handle communication between the frontend and backend (relevant for retrieving options).</snippet>
    </doc>
    <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Game State Management</section>
        <snippet>Player choices will be stored in `GameSession`.</snippet>
    </doc>
    <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Testing Strategy</section>
        <snippet>E2E Tests using Playwright.</snippet>
    </doc>
    <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Epic 4: Expanding Variety and Replayability</section>
        <snippet>This Epic aims to significantly increase the breadth of content and player choice within the "AI Escape" game, delivering on the promise of endless replayability.</snippet>
    </doc>
    <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Story 4.3: Implement Enhanced Game Setup Flow</section>
        <snippet>Story 4.3 focuses on providing an enhanced game setup experience with more options and clearer guidance for players to customize their gameplay effectively.</snippet>
    </doc>
    <doc>
        <path>docs/ux-design-specification.md</path>
        <title>AI Escape - UX Design Specification</title>
        <section>5. User Journey Flows</section>
        <snippet>UX Design outlines user journey flows for New Game Creation and Load Game, which will rely on the backend's game state management to function correctly. This implies the need for dynamic content in the UI.</snippet>
    </doc>
</docs>
    <code>
        <code-ref>
            <path>config.py</path>
            <kind>file</kind>
            <reason>To define expanded lists of themes, locations, puzzle types, and difficulty levels.</reason>
        </code-ref>
        <code-ref>
            <path>routes.py</path>
            <kind>file</kind>
            <reason>To create or update Flask API routes to expose game setup options (`GET /game_setup_options`).</reason>
        </code-ref>
        <code-ref>
            <path>templates/game_setup.html</path>
            <kind>file</kind>
            <reason>To implement enhanced UI for game setup.</reason>
        </code-ref>
        <code-ref>
            <path>models.py</path>
            <kind>file</kind>
            <reason>To ensure selected themes, locations, puzzle types, and difficulty levels are passed to `create_game_session` and stored in `GameSession`.</reason>
        </code-ref>
        <code-ref>
            <path>tests/</path>
            <kind>directory</kind>
            <reason>For new unit and integration tests.</reason>
        </code-ref>
    </code>
    <dependencies>
      <python>
        <package name="Flask" version="3.1.2" />
        <package name="python-dotenv" version="?" />
        <package name="gunicorn" version="?" />
        <package name="pytest" version="?" />
        <note>Core Python dependencies for the Flask application and Google Gemini API client.</note>
      </python>
      <node>
        <package name="playwright" version="?" />
        <note>Existing Node.js project dependencies for E2E testing.</note>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>
        <type>Required Pattern</type>
        <description>Python Flask application structure (modular, with `app.py`, `static/`, `templates/`, `models.py`, `routes.py`, `services/`, `tests/`).</description>
        <source>docs/architecture.md#Project-Structure</source>
    </constraint>
    <constraint>
        <type>Required Pattern</type>
        <description>WCAG 2.1 Level AA accessibility compliance.</description>
        <source>docs/architecture.md#Accessibility-Implementation</source>
    </constraint>
    <constraint>
        <type>Required Pattern</type>
        <description>Stateless JWT Authentication.</description>
        <source>docs/architecture.md#Security-Architecture</source>
    </constraint>
    <constraint>
        <type>Layer Restriction</type>
        <description>Frontend (Jinja2 templates/Static assets) &lt;-> Backend (Flask Routes/API Endpoints).</description>
        <source>docs/architecture.md#Integration-Points</source>
    </constraint>
    <constraint>
        <type>Layer Restriction</type>
        <description>Flask Routes/API Endpoints &lt;-> AI Service (Gemini API).</description>
        <source>docs/architecture.md#Integration-Points</source>
    </constraint>
    <constraint>
        <type>Layer Restriction</type>
        <description>Flask Routes/API Endpoints &lt;-> Database (Supabase PostgreSQL via SQLAlchemy).</description>
        <source>docs/architecture.md#Integration-Points</source>
    </constraint>
    <constraint>
        <type>Testing Requirement</type>
        <description>Unit Tests (Pytest with `pytest-mock`).</description>
        <source>docs/architecture.md#Comprehensive-Testing-Strategy</source>
    </constraint>
    <constraint>
        <type>Testing Requirement</type>
        <description>Integration Tests (Pytest).</description>
        <source>docs/architecture.md#Comprehensive-Testing-Strategy</source>
    </constraint>
    <constraint>
        <type>Testing Requirement</type>
        <description>E2E Tests (Playwright).</description>
        <source>docs/architecture.md#Comprehensive-Testing-Strategy</source>
    </constraint>
    <constraint>
        <type>Coding Standard</type>
        <description>Python Classes: `PascalCase`, Python Functions/Variables: `snake_case`, Python Modules/Files: `snake_case`, Database Tables: `snake_case` (plural), Database Columns: `snake_case`, API Endpoints: `kebab-case` for URL paths, `snake_case` for query parameters, Constants: `SCREAMING_SNAKE_CASE`.</description>
        <source>docs/architecture.md#Consistency-Rules</source>
    </constraint>
    <constraint>
        <type>Coding Standard</type>
        <description>Code Organization: Modular Flask application layout.</description>
        <source>docs/architecture.md#Code-Organization</source>
    </constraint>
</constraints>

<interfaces>
    <interface>
        <name>/game_setup_options</name>
        <kind>REST endpoint</kind>
        <signature>GET /game_setup_options</signature>
        <path>routes.py</path>
    </interface>
</interfaces>
  <tests>
    <standards>
      <standard>
        <framework>Pytest</framework>
        <type>Unit, Integration</type>
        <note>Unit and integration tests for backend logic.</note>
        <source>docs/architecture.md#Testing-Strategy</source>
      </standard>
      <standard>
        <framework>Playwright</framework>
        <type>E2E</type>
        <source>docs/architecture.md#Comprehensive-Testing-Strategy</source>
      </standard>
    </standards>
    <locations>
      <location>tests/</location>
      <note>Mirroring the application's module structure (e.g., `tests/unit/`, `tests/integration/`).</note>
    </locations>
    <ideas>
      <idea ac="1">
        <description>Write unit tests for the data structure holding game setup options.</description>
      </idea>
      <idea ac="1">
        <description>Write integration tests for the `GET /game_setup_options` Flask route, verifying correct option retrieval.</description>
      </idea>
      <idea ac="1">
        <description>Write E2E tests to simulate player interaction with the enhanced game setup flow and verify correct option display and selection.</description>
      </idea>
    </ideas>
  </tests>
</story-context>