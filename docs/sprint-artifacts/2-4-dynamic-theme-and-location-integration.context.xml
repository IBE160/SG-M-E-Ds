<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>4</storyId>
    <title>Dynamic Theme and Location Integration</title>
    <status>drafted</status>
    <generatedAt>2025-12-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-4-dynamic-theme-and-location-integration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>player</asA>
    <iWant>my chosen theme and location to influence the AI-generated story and room descriptions</iWant>
    <soThat>my customization choices feel impactful</soThat>
    <tasks>
- [ ] AC 1: Update `GameSession` model to store theme and location.
  - [ ] Subtask: Ensure `GameSession` in `models.py` has fields for `theme` and `location` (already present with defaults).
- [ ] AC 1: Modify AI prompt generation in `services/ai_service.py`.
  - [ ] Subtask: Ensure prompts sent to the Gemini API for narrative and room description generation include the `theme` and `location` from the `GameSession`.
  - [ ] Subtask: Implement prompt engineering techniques to emphasize consistency with chosen theme/location.
- [ ] AC 1: Integrate theme/location selection into `start_game` API.
  - [ ] Subtask: Update the `POST /start_game` route in `routes.py` to receive `theme` and `location` parameters and pass them to `create_game_session`.
- [ ] AC 1: Implement unit and integration tests.
  - [ ] Subtask: Write unit tests for `services/ai_service.py` to verify that `theme` and `location` are correctly embedded in prompts.
  - [ ] Subtask: Write integration tests for the `POST /start_game` route to confirm `GameSession` is initialized with chosen `theme` and `location`.
  - [ ] Subtask: Manual/Exploratory testing to visually confirm that AI-generated content (narrative, room descriptions) is consistent with the selected theme and location.
</tasks>
  </story>

  <acceptanceCriteria>
    <criterion>Given the player selects a theme (e.g., "Space Station") and location (e.g., "Mars Colony"), when the AI generates the narrative and room descriptions, then the content consistently reflects the chosen theme and location.</criterion>
</acceptanceCriteria>

  <artifacts>
<docs>
    <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document: AI Escape</title>
        <section>FR-001: Dynamic Content Generation</section>
        <snippet>The AI generates unique storylines, and creates room descriptions based on user input.</snippet>
    </doc>
    <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document: AI Escape</title>
        <section>FR-002: Player-Driven Customization</section>
        <snippet>Players tailor their adventure by choosing a theme, location, difficulty level.</snippet>
    </doc>
    <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>AI Service Integration</section>
        <snippet>Utilizes Gemini Pro / Gemini 1.5 Pro.</snippet>
    </doc>
    <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>AI Client Library</section>
        <snippet>Employs `google-generativeai 0.8.5` for interacting with the Gemini API.</snippet>
    </doc>
    <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Prompt Management Strategy</section>
        <snippet>Structured Prompting.</snippet>
    </doc>
    <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Game State Management & Persistence</section>
        <snippet>`GameSession` entity will track `theme` and `location`.</snippet>
    </doc>
    <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>API Pattern for AI interactions</section>
        <snippet>Flask API Routes.</snippet>
    </doc>
    <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Epic 2: Introducing the AI Storyteller</section>
        <snippet>This Epic focuses on transitioning the "AI Escape" game from static, hard-coded story and room descriptions to dynamically generated content powered by AI.</snippet>
    </doc>
    <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Story 2.4: Dynamic Theme and Location Integration</section>
        <snippet>Story 2.4 focuses on ensuring chosen themes and locations influence AI-generated stories and room descriptions, making player customization impactful.</snippet>
    </doc>
    <doc>
        <path>docs/ux-design-specification.md</path>
        <title>AI Escape - UX Design Specification</title>
        <section>5. User Journey Flows</section>
        <snippet>UX Design outlines user journey flows for New Game Creation and Load Game, which will rely on the backend's game state management to function correctly. This implies the need for dynamic content in the UI.</snippet>
    </doc>
</docs>
    <code>
        <code-ref>
            <path>models.py</path>
            <kind>file</kind>
            <reason>Update GameSession to store theme and location</reason>
        </code-ref>
        <code-ref>
            <path>services/ai_service.py</path>
            <kind>file</kind>
            <reason>Modify AI prompt generation to include theme and location</reason>
        </code-ref>
        <code-ref>
            <path>routes.py</path>
            <kind>file</kind>
            <reason>Integrate theme/location selection into `start_game` API</reason>
        </code-ref>
        <code-ref>
            <path>tests/</path>
            <kind>directory</kind>
            <reason>For new unit and integration tests</reason>
        </code-ref>
    </code>
    <dependencies>
      <python>
        <package name="Flask" version="3.1.2" />
        <package name="python-dotenv" version="?" />
        <package name="gunicorn" version="?" />
        <package name="pytest" version="?" />
        <package name="google-generativeai" version="0.8.5" />
        <note>Core Python dependencies for the Flask application and Google Gemini API client.</note>
      </python>
      <node>
        <package name="playwright" version="?" />
        <note>Existing Node.js project dependencies for E2E testing.</note>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>
        <type>Required Pattern</type>
        <description>Python Flask application structure (modular, with `app.py`, `static/`, `templates/`, `models.py`, `routes.py`, `services/`, `tests/`).</description>
        <source>docs/architecture.md#Project-Structure</source>
    </constraint>
    <constraint>
        <type>Required Pattern</type>
        <description>WCAG 2.1 Level AA accessibility compliance.</description>
        <source>docs/architecture.md#Accessibility-Implementation</source>
    </constraint>
    <constraint>
        <type>Required Pattern</type>
        <description>Stateless JWT Authentication.</description>
        <source>docs/architecture.md#Security-Architecture</source>
    </constraint>
    <constraint>
        <type>Layer Restriction</type>
        <description>Frontend (Jinja2 templates/Static assets) &lt;-> Backend (Flask Routes/API Endpoints).</description>
        <source>docs/architecture.md#Integration-Points</source>
    </constraint>
    <constraint>
        <type>Layer Restriction</type>
        <description>Flask Routes/API Endpoints &lt;-> AI Service (Gemini API).</description>
        <source>docs/architecture.md#Integration-Points</source>
    </constraint>
    <constraint>
        <type>Layer Restriction</type>
        <description>Flask Routes/API Endpoints &lt;-> Database (Supabase PostgreSQL via SQLAlchemy).</description>
        <source>docs/architecture.md#Integration-Points</source>
    </constraint>
    <constraint>
        <type>Testing Requirement</type>
        <description>Unit Tests (Pytest with `pytest-mock`).</description>
        <source>docs/architecture.md#Comprehensive-Testing-Strategy</source>
    </constraint>
    <constraint>
        <type>Testing Requirement</type>
        <description>Integration Tests (Pytest).</description>
        <source>docs/architecture.md#Comprehensive-Testing-Strategy</source>
    </constraint>
    <constraint>
        <type>Testing Requirement</type>
        <description>E2E Tests (Playwright).</description>
        <source>docs/architecture.md#Comprehensive-Testing-Strategy</source>
    </constraint>
    <constraint>
        <type>Coding Standard</type>
        <description>Python Classes: `PascalCase`, Python Functions/Variables: `snake_case`, Python Modules/Files: `snake_case`, Database Tables: `snake_case` (plural), Database Columns: `snake_case`, API Endpoints: `kebab-case` for URL paths, `snake_case` for query parameters, Constants: `SCREAMING_SNAKE_CASE`.</description>
        <source>docs/architecture.md#Consistency-Rules</source>
    </constraint>
    <constraint>
        <type>Coding Standard</type>
        <description>Code Organization: Modular Flask application layout.</description>
        <source>docs/architecture.md#Code-Organization</source>
    </constraint>
</constraints>

<interfaces></interfaces>
  <tests>
    <standards>
      <standard>
        <framework>Pytest</framework>
        <type>Unit, Integration</type>
        <note>Unit tests should mock the Gemini API.</note>
        <source>docs/architecture.md#Testing-Strategy</source>
      </standard>
      <standard>
        <framework>Playwright</framework>
        <type>E2E</type>
        <source>docs/architecture.md#Comprehensive-Testing-Strategy</source>
      </standard>
    </standards>
    <locations>
      <location>tests/</location>
      <note>Mirroring the application's module structure (e.g., `tests/unit/`, `tests/integration/`).</note>
    </locations>
    <ideas>
      <idea ac="1">
        <description>Write unit tests for `services/ai_service.py` to verify that `theme` and `location` are correctly embedded in prompts.</description>
      </idea>
      <idea ac="1">
        <description>Write integration tests for the `POST /start_game` route to confirm `GameSession` is initialized with chosen `theme` and `location`.</description>
      </idea>
      <idea ac="1">
        <description>Manual/Exploratory testing to visually confirm that AI-generated content (narrative, room descriptions) is consistent with the selected theme and location.</description>
      </idea>
    </ideas>
  </tests>
</story-context>