<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>5</epicId>
    <storyId>1</storyId>
    <title>Implement Save/Load Game Functionality</title>
    <status>drafted</status>
    <generatedAt>2025-12-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/5-1-implement-save-load-game-functionality.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>player</asA>
    <iWant>to save my game progress and load it later</iWant>
    <soThat>I can continue my adventure at any time</soThat>
    <tasks>
- [ ] AC 1: Extend `services/game_logic.py` to handle save game operations.
  - [ ] Subtask: Implement a function to serialize the current `GameSession` state and store it in the database.
- [ ] AC 2: Extend `services/game_logic.py` to handle load game operations.
  - [ ] Subtask: Implement a function to retrieve a saved `GameSession` from the database and deserialize it.
- [ ] AC 1, 2: Create Flask API routes for save/load functionality.
  - [ ] Subtask: Define a `POST /save_game` endpoint in `routes.py` to trigger game saving.
  - [ ] Subtask: Define a `GET /load_game/<int:session_id>` endpoint in `routes.py` to retrieve a specific saved game.
  - [ ] Subtask: Define a `GET /saved_games` endpoint to list available saved games (e.g., for display in a "Load Game" screen).
- [ ] AC 1, 2: Implement UI for save/load interaction.
  - [ ] Subtask: Create/modify Jinja2 templates for a "Save Game" option (e.g., in a pause menu) and a "Load Game" screen (e.g., displaying a list of saved games).
  - [ ] Subtask: Implement client-side logic to call the save/load API endpoints.
- [ ] AC 1, 2: Implement unit and integration tests.
  - [ ] Subtask: Write unit tests for `services/game_logic.py` functions related to serialization, deserialization, and database interaction for save/load.
  - [ ] Subtask: Write integration tests for Flask routes (`/save_game`, `/load_game`, `/saved_games`), verifying correct data persistence and retrieval.
  - [ ] Subtask: Write E2E tests to simulate player saving and loading games, verifying state is correctly preserved and restored.
</tasks>
  </story>

  <acceptanceCriteria>
    <criterion>Given I am in the middle of a game, when I select the "Save Game" option, then my current progress (e.g., room, inventory, narrative state) is saved.</criterion>
    <criterion>And from the main menu, I can select "Load Game" to resume from my saved state.</criterion>
</acceptanceCriteria>

  <artifacts>
<docs>
    <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document: AI Escape</title>
        <section>Future Consideration: Progression Management</section>
        <snippet>Building save/load game functionality.</snippet>
    </doc>
    <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document: AI Escape</title>
        <section>Note on Scope Discrepancy</section>
        <snippet>The `prd.md` explicitly lists "Load/Save game functionality" as "Out of Scope (MVP)". Its inclusion in this epic suggests a change in MVP scope or that Epic 5 is intended for a post-MVP phase, or that it is now considered In Scope. For the purpose of this tech spec, it is treated as In Scope.</snippet>
    </doc>
    <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Data Persistence</section>
        <snippet>Supabase (PostgreSQL) managed via SQLAlchemy ORM.</snippet>
    </doc>
    <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Game State Management & Persistence</section>
        <snippet>`GameSession` entity will track game state.</snippet>
    </doc>
    <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Testing Strategy</section>
        <snippet>Unit, Integration Tests using Pytest.</snippet>
    </doc>
    <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Epic 5: Game Utility Features</section>
        <snippet>This Epic focuses on providing players with essential utility features such as saving/loading games, getting help, and adjusting options.</snippet>
    </doc>
    <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Story 5.1: Implement Save/Load Game Functionality</section>
        <snippet>Story 5.1 focuses on enabling players to save their current game progress (room, inventory, narrative state) and load it later to resume gameplay.</snippet>
    </doc>
    <doc>
        <path>docs/ux-design-specification.md</path>
        <title>AI Escape - UX Design Specification</title>
        <section>5. User Journey Flows</section>
        <snippet>UX Design outlines user journey flows for New Game Creation and Load Game, which will rely on the backend's game state management to function correctly. This implies the need for dynamic content in the UI.</snippet>
    </doc>
</docs>
    <code>
        <code-ref>
            <path>services/game_logic.py</path>
            <kind>file</kind>
            <reason>Extend to handle save game operations (serialize/deserialize GameSession state, store in DB)</reason>
        </code-ref>
        <code-ref>
            <path>routes.py</path>
            <kind>file</kind>
            <reason>Create Flask API routes for save/load functionality (`POST /save_game`, `GET /load_game/<int:session_id>`, `GET /saved_games`)</reason>
        </code-ref>
        <code-ref>
            <path>templates/</path>
            <kind>directory</kind>
            <reason>Create/modify Jinja2 templates for "Save Game" option and "Load Game" screen</reason>
        </code-ref>
        <code-ref>
            <path>tests/</path>
            <kind>directory</kind>
            <reason>For new unit and integration tests</reason>
        </code-ref>
    </code>
    <dependencies>
      <python>
        <package name="Flask" version="3.1.2" />
        <package name="python-dotenv" version="?" />
        <package name="gunicorn" version="?" />
        <package name="pytest" version="?" />
        <note>Core Python dependencies for the Flask application.</note>
      </python>
      <node>
        <package name="playwright" version="?" />
        <note>Existing Node.js project dependencies for E2E testing.</note>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>
        <type>Required Pattern</type>
        <description>Python Flask application structure (modular, with `app.py`, `static/`, `templates/`, `models.py`, `routes.py`, `services/`, `tests/`).</description>
        <source>docs/architecture.md#Project-Structure</source>
    </constraint>
    <constraint>
        <type>Required Pattern</type>
        <description>WCAG 2.1 Level AA accessibility compliance.</description>
        <source>docs/architecture.md#Accessibility-Implementation</source>
    </constraint>
    <constraint>
        <type>Required Pattern</type>
        <description>Stateless JWT Authentication.</description>
        <source>docs/architecture.md#Security-Architecture</source>
    </constraint>
    <constraint>
        <type>Layer Restriction</type>
        <description>Frontend (Jinja2 templates/Static assets) &lt;-> Backend (Flask Routes/API Endpoints).</description>
        <source>docs/architecture.md#Integration-Points</source>
    </constraint>
    <constraint>
        <type>Layer Restriction</type>
        <description>Flask Routes/API Endpoints &lt;-> AI Service (Gemini API).</description>
        <source>docs/architecture.md#Integration-Points</source>
    </constraint>
    <constraint>
        <type>Layer Restriction</type>
        <description>Flask Routes/API Endpoints &lt;-> Database (Supabase PostgreSQL via SQLAlchemy).</description>
        <source>docs/architecture.md#Integration-Points</source>
    </constraint>
    <constraint>
        <type>Testing Requirement</type>
        <description>Unit Tests (Pytest with `pytest-mock`).</description>
        <source>docs/architecture.md#Comprehensive-Testing-Strategy</source>
    </constraint>
    <constraint>
        <type>Testing Requirement</type>
        <description>Integration Tests (Pytest).</description>
        <source>docs/architecture.md#Comprehensive-Testing-Strategy</source>
    </constraint>
    <constraint>
        <type>Testing Requirement</type>
        <description>E2E Tests (Playwright).</description>
        <source>docs/architecture.md#Comprehensive-Testing-Strategy</source>
    </constraint>
    <constraint>
        <type>Coding Standard</type>
        <description>Python Classes: `PascalCase`, Python Functions/Variables: `snake_case`, Python Modules/Files: `snake_case`, Database Tables: `snake_case` (plural), Database Columns: `snake_case`, API Endpoints: `kebab-case` for URL paths, `snake_case` for query parameters, Constants: `SCREAMING_SNAKE_CASE`.</description>
        <source>docs/architecture.md#Consistency-Rules</source>
    </constraint>
    <constraint>
        <type>Coding Standard</type>
        <description>Code Organization: Modular Flask application layout.</description>
        <source>docs/architecture.md#Code-Organization</source>
    </constraint>
</constraints>

<interfaces>
    <interface>
        <name>/save_game</name>
        <kind>REST endpoint</kind>
        <signature>POST /save_game</signature>
        <path>routes.py</path>
    </interface>
    <interface>
        <name>/load_game</name>
        <kind>REST endpoint</kind>
        <signature>GET /load_game/&lt;int:session_id&gt;</signature>
        <path>routes.py</path>
    </interface>
    <interface>
        <name>/saved_games</name>
        <kind>REST endpoint</kind>
        <signature>GET /saved_games</signature>
        <path>routes.py</path>
    </interface>
</interfaces>
  <tests>
    <standards>
      <standard>
        <framework>Pytest</framework>
        <type>Unit, Integration</type>
        <note>Unit and integration tests for backend logic.</note>
        <source>docs/architecture.md#Testing-Strategy</source>
      </standard>
      <standard>
        <framework>Playwright</framework>
        <type>E2E</type>
        <source>docs/architecture.md#Comprehensive-Testing-Strategy</source>
      </standard>
    </standards>
    <locations>
      <location>tests/</location>
      <note>Mirroring the application's module structure (e.g., `tests/unit/`, `tests/integration/`).</note>
    </locations>
    <ideas>
      <idea ac="1">
        <description>Write unit tests for `services/game_logic.py` functions related to serialization, deserialization, and database interaction for save/load.</description>
      </idea>
      <idea ac="2">
        <description>Write integration tests for Flask routes (`/save_game`, `/load_game`, `/saved_games`), verifying correct data persistence and retrieval.</description>
      </idea>
      <idea ac="2">
        <description>Write E2E tests to simulate player saving and loading games, verifying state is correctly preserved and restored.</description>
      </idea>
    </ideas>
  </tests>
</story-context>